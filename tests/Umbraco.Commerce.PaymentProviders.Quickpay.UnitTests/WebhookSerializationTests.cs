using System.Text.Json;
using FluentAssertions;
using Umbraco.Commerce.PaymentProviders.Quickpay.Api.Models;

namespace Umbraco.Commerce.PaymentProviders.Quickpay.UnitTests
{
    public class WebhookSerializationTests
    {
        [Theory]
        [InlineData("{\"id\":436912480,\"ulid\":\"01HKSG184XGFM1355VMSXP63AH\",\"merchant_id\":172193,\"order_id\":\"-01470-39151-3KRD3\",\"accepted\":true,\"type\":\"Payment\",\"text_on_statement\":null,\"branding_id\":null,\"variables\":{\"orderReference\":\"umb://order/7b9cb4c3-1211-4a37-9a31-018cf3005c3a/ORDER-01470-39151-3KRD3\",\"orderId\":\"7b9cb4c3-1211-4a37-9a31-018cf3005c3a\",\"orderNumber\":\"ORDER-01470-39151-3KRD3\"},\"currency\":\"EUR\",\"state\":\"pending\",\"metadata\":{\"type\":\"card\",\"origin\":\"form\",\"brand\":\"visa\",\"bin\":\"100000\",\"corporate\":false,\"last4\":\"0008\",\"exp_month\":2,\"exp_year\":2025,\"country\":\"SWE\",\"is_3d_secure\":true,\"3d_secure_type\":\"frictionless\",\"issued_to\":\"Quickpay Test\",\"hash\":\"62205d22b4a56346a2b61OQMfbEmBegETeRzVcIib2FRjR6JX5yR\",\"moto\":false,\"number\":null,\"customer_ip\":\"116.99.41.114\",\"customer_country\":\"VN\",\"fraud_suspected\":true,\"fraud_remarks\":[\"Flagged because FraudFilter rule set \\\"PSD2 - payments\\\" (id: 336871) triggered.\"],\"fraud_reported\":false,\"fraud_report_description\":null,\"fraud_reported_at\":null,\"nin_number\":null,\"nin_country_code\":null,\"nin_gender\":null,\"shopsystem_name\":null,\"shopsystem_version\":null,\"ch_mid\":null},\"link\":{\"url\":\"https://payment.quickpay.net/payments/f356cc5456463123306bda20f2341786eb82cfa807a247d2f3670062d92e4f9a\",\"agreement_id\":785548,\"language\":\"en\",\"amount\":6840,\"continue_url\":\"https://sterling-jaybird-game.ngrok-free.app/umbraco/commerce/payment/continue/quickpay-v10-checkout/7b9cb4c3-1211-4a37-9a31-018cf3005c3a/ORDER-01470-39151-3KRD3/575d4c8220a57a94225890acd516a5c67c73457b\",\"cancel_url\":\"https://sterling-jaybird-game.ngrok-free.app/umbraco/commerce/payment/cancel/quickpay-v10-checkout/7b9cb4c3-1211-4a37-9a31-018cf3005c3a/ORDER-01470-39151-3KRD3/8d28b17bf8ef3947b84f1d8f98d810c0117de745\",\"callback_url\":\"https://sterling-jaybird-game.ngrok-free.app/umbraco/commerce/payment/callback/quickpay-v10-checkout/7b9cb4c3-1211-4a37-9a31-018cf3005c3a/ORDER-01470-39151-3KRD3/7f4eb6a69b5574fd140bac09d8942584ea3b3b43\",\"payment_methods\":null,\"auto_fee\":true,\"auto_capture\":true,\"auto_capture_at\":\"2024-01-10T08:52:55.339Z\",\"branding_id\":null,\"google_analytics_client_id\":null,\"google_analytics_tracking_id\":null,\"version\":\"v10\",\"acquirer\":null,\"deadline\":null,\"framed\":false,\"branding_config\":{},\"invoice_address_selection\":null,\"shipping_address_selection\":null,\"fee_vat\":null,\"moto\":false,\"customer_email\":null},\"shipping_address\":null,\"invoice_address\":null,\"basket\":[],\"shipping\":null,\"operations\":[{\"id\":1,\"type\":\"authorize\",\"amount\":6840,\"pending\":false,\"qp_status_code\":\"30100\",\"qp_status_msg\":\"3D Secure is required by FraudFilter rule set: \\\"PSD2 - payments\\\" (id: 336871)\",\"aq_status_code\":null,\"aq_status_msg\":null,\"data\":{},\"callback_url\":\"https://sterling-jaybird-game.ngrok-free.app/umbraco/commerce/payment/callback/quickpay-v10-checkout/7b9cb4c3-1211-4a37-9a31-018cf3005c3a/ORDER-01470-39151-3KRD3/7f4eb6a69b5574fd140bac09d8942584ea3b3b43\",\"callback_success\":null,\"callback_response_code\":null,\"callback_duration\":null,\"acquirer\":\"clearhaus\",\"3d_secure_status\":null,\"callback_at\":null,\"created_at\":\"2024-01-10T10:52:46Z\"},{\"id\":2,\"type\":\"authorize\",\"amount\":6840,\"pending\":false,\"qp_status_code\":\"20000\",\"qp_status_msg\":\"Approved\",\"aq_status_code\":\"20000\",\"aq_status_msg\":\"Approved\",\"data\":{},\"callback_url\":\"https://sterling-jaybird-game.ngrok-free.app/umbraco/commerce/payment/callback/quickpay-v10-checkout/7b9cb4c3-1211-4a37-9a31-018cf3005c3a/ORDER-01470-39151-3KRD3/7f4eb6a69b5574fd140bac09d8942584ea3b3b43\",\"callback_success\":null,\"callback_response_code\":null,\"callback_duration\":null,\"acquirer\":\"clearhaus\",\"3d_secure_status\":\"Y\",\"callback_at\":null,\"created_at\":\"2024-01-10T10:52:59Z\"}],\"test_mode\":true,\"acquirer\":\"clearhaus\",\"facilitator\":null,\"created_at\":\"2024-01-10T10:52:33Z\",\"updated_at\":\"2024-01-10T10:53:00Z\",\"retented_at\":null,\"balance\":0,\"fee\":0,\"deadline_at\":null,\"reseller_id\":2}")]
        [InlineData("{\"id\":436917691,\"ulid\":null,\"merchant_id\":172193,\"order_id\":\"-01470-40661-ZV5LK\",\"accepted\":false,\"type\":\"Payment\",\"text_on_statement\":null,\"branding_id\":null,\"variables\":{\"orderReference\":\"umb://order/ef589fef-c65c-44cb-bb67-018cf313207e/ORDER-01470-40661-ZV5LK\",\"orderId\":\"ef589fef-c65c-44cb-bb67-018cf313207e\",\"orderNumber\":\"ORDER-01470-40661-ZV5LK\"},\"currency\":\"EUR\",\"state\":\"initial\",\"metadata\":{\"type\":null,\"origin\":null,\"brand\":null,\"bin\":null,\"corporate\":null,\"last4\":null,\"exp_month\":null,\"exp_year\":null,\"country\":null,\"is_3d_secure\":null,\"3d_secure_type\":null,\"issued_to\":null,\"hash\":null,\"moto\":null,\"number\":null,\"customer_ip\":null,\"customer_country\":null,\"fraud_suspected\":false,\"fraud_remarks\":[],\"fraud_reported\":false,\"fraud_report_description\":null,\"fraud_reported_at\":null,\"nin_number\":null,\"nin_country_code\":null,\"nin_gender\":null,\"shopsystem_name\":null,\"shopsystem_version\":null,\"ch_mid\":null},\"link\":null,\"shipping_address\":null,\"invoice_address\":null,\"basket\":[],\"shipping\":null,\"operations\":[],\"test_mode\":false,\"acquirer\":null,\"facilitator\":null,\"created_at\":\"2024-01-10T11:17:43Z\",\"updated_at\":\"2024-01-10T11:17:43Z\",\"retented_at\":null,\"balance\":0,\"fee\":null,\"deadline_at\":null}")]
        [InlineData("{\"id\":440430135,\"ulid\":\"01HNCADWCXT9DZ2DK2T1XD4D68\",\"merchant_id\":172193,\"order_id\":\"-01490-16550-VY6DT\",\"accepted\":true,\"type\":\"Payment\",\"text_on_statement\":null,\"branding_id\":null,\"variables\":{\"orderReference\":\"umb://order/6608942b-f82b-4e0e-a4b4-018d58a69310/ORDER-01490-16550-VY6DT\",\"orderId\":\"6608942b-f82b-4e0e-a4b4-018d58a69310\",\"orderNumber\":\"ORDER-01490-16550-VY6DT\"},\"currency\":\"EUR\",\"state\":\"processed\",\"metadata\":{\"type\":\"card\",\"origin\":\"form\",\"brand\":\"visa\",\"bin\":\"100000\",\"corporate\":false,\"last4\":\"0032\",\"exp_month\":2,\"exp_year\":2026,\"country\":\"DNK\",\"is_3d_secure\":false,\"3d_secure_type\":null,\"issued_to\":\"Capture rejected\",\"hash\":\"62205d22b4a56346a2b61OmXxtYrUVRkkush7vPYaD2IpOK5ixs\",\"moto\":false,\"number\":null,\"customer_ip\":\"116.99.48.122\",\"customer_country\":\"VN\",\"fraud_suspected\":false,\"fraud_remarks\":[],\"fraud_reported\":false,\"fraud_report_description\":null,\"fraud_reported_at\":null,\"nin_number\":null,\"nin_country_code\":null,\"nin_gender\":null,\"shopsystem_name\":null,\"shopsystem_version\":null,\"ch_mid\":null},\"link\":{\"url\":\"https://payment.quickpay.net/payments/469a86376f31e983ba78bb2d2d02ede9a3aef0b5dd4d13bdd6372a3a87d9558e\",\"agreement_id\":785548,\"language\":\"en\",\"amount\":720,\"continue_url\":\"https://sterling-jaybird-game.ngrok-free.app/umbraco/commerce/payment/continue/quickpay-v10-checkout/6608942b-f82b-4e0e-a4b4-018d58a69310/ORDER-01490-16550-VY6DT/acca44ce5d6a1e8fa85b0438426c3a7cec348a6c\",\"cancel_url\":\"https://sterling-jaybird-game.ngrok-free.app/umbraco/commerce/payment/cancel/quickpay-v10-checkout/6608942b-f82b-4e0e-a4b4-018d58a69310/ORDER-01490-16550-VY6DT/160eab1a52cf52c754bb3da1a30f7ad4c6a99a39\",\"callback_url\":\"https://sterling-jaybird-game.ngrok-free.app/umbraco/commerce/payment/callback/quickpay-v10-checkout/6608942b-f82b-4e0e-a4b4-018d58a69310/ORDER-01490-16550-VY6DT/d0d0b315d0cb07d1f2ebe19c6011a2b805949270\",\"payment_methods\":null,\"auto_fee\":true,\"auto_capture\":true,\"auto_capture_at\":\"2024-01-10T08:52:55.339Z\",\"branding_id\":null,\"google_analytics_client_id\":null,\"google_analytics_tracking_id\":null,\"version\":\"v10\",\"acquirer\":null,\"deadline\":null,\"framed\":false,\"branding_config\":{},\"invoice_address_selection\":null,\"shipping_address_selection\":null,\"fee_vat\":null,\"moto\":false,\"customer_email\":null},\"shipping_address\":null,\"invoice_address\":null,\"basket\":[],\"shipping\":null,\"operations\":[{\"id\":1,\"type\":\"authorize\",\"amount\":720,\"pending\":false,\"qp_status_code\":\"20000\",\"qp_status_msg\":\"Approved\",\"aq_status_code\":\"20000\",\"aq_status_msg\":\"Approved\",\"data\":{},\"callback_url\":\"https://sterling-jaybird-game.ngrok-free.app/umbraco/commerce/payment/callback/quickpay-v10-checkout/6608942b-f82b-4e0e-a4b4-018d58a69310/ORDER-01490-16550-VY6DT/d0d0b315d0cb07d1f2ebe19c6011a2b805949270\",\"callback_success\":true,\"callback_response_code\":\"200\",\"callback_duration\":3316,\"acquirer\":\"clearhaus\",\"3d_secure_status\":null,\"callback_at\":\"2024-01-30T04:36:01Z\",\"created_at\":\"2024-01-30T04:36:01Z\"},{\"id\":2,\"type\":\"capture\",\"amount\":720,\"pending\":false,\"qp_status_code\":\"40000\",\"qp_status_msg\":\"Rejected test operation\",\"aq_status_code\":\"40000\",\"aq_status_msg\":\"Rejected test operation\",\"data\":{},\"callback_url\":\"https://sterling-jaybird-game.ngrok-free.app/umbraco/commerce/payment/callback/quickpay-v10-checkout/6608942b-f82b-4e0e-a4b4-018d58a69310/ORDER-01490-16550-VY6DT/d0d0b315d0cb07d1f2ebe19c6011a2b805949270\",\"callback_success\":true,\"callback_response_code\":\"200\",\"callback_duration\":800,\"acquirer\":\"clearhaus\",\"3d_secure_status\":null,\"callback_at\":\"2024-01-30T04:36:01Z\",\"created_at\":\"2024-01-30T04:36:01Z\"},{\"id\":3,\"type\":\"cancel\",\"amount\":null,\"pending\":false,\"qp_status_code\":\"20000\",\"qp_status_msg\":\"Approved\",\"aq_status_code\":\"20000\",\"aq_status_msg\":\"Approved\",\"data\":{},\"callback_url\":\"https://sterling-jaybird-game.ngrok-free.app/umbraco/commerce/payment/callback/quickpay-checkout/6e54f4bd-7481-405b-b620-018cf2f8f379\",\"callback_success\":true,\"callback_response_code\":\"200\",\"callback_duration\":1063,\"acquirer\":\"clearhaus\",\"3d_secure_status\":null,\"callback_at\":\"2024-01-30T04:36:55Z\",\"created_at\":\"2024-01-30T04:36:55Z\"}],\"test_mode\":true,\"acquirer\":\"clearhaus\",\"facilitator\":null,\"created_at\":\"2024-01-30T04:35:52Z\",\"updated_at\":\"2024-01-30T04:36:56Z\",\"retented_at\":null,\"balance\":0,\"fee\":0,\"deadline_at\":null}")]
        public void QuickpayPayment_Deserialization_Should_Succeed(string json)
        {
            // preparation
            JsonSerializerOptions options = new(JsonSerializerDefaults.Web);
            // execution
            QuickpayPayment? deserialized = JsonSerializer.Deserialize<QuickpayPayment>(json, options);

            // asserts
            deserialized.Should().NotBeNull();
        }
    }
}
